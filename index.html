<script>
document.addEventListener("DOMContentLoaded", function () {
    const pageFlip = new St.PageFlip(document.getElementById("book"), {
        width: 1100,  // Szélesebb megjelenítés
        height: 800,
        size: "fixed",
        maxShadowOpacity: 0.2,
        showCover: false,  // Kemény borítók kikapcsolva
        mobileScrollSupport: false,
        flippingTime: 750,
        usePortrait: window.innerWidth < 768,
        drawShadow: true,
        swipeDistance: 30,
        clickEventForward: false,
        disableFlipByClick: true
    });

    // Oldaldefiníciók egységes kezelése
    const pages = Array.from({length: 10}, (_, i) => ({
        type: i === 0 ? 'image' : 'html',
        path: i === 0 ? 'images/oldalak/borito.webp' : `pages/oldal-${i}.html`
    }));

    // Optimalizált betöltési rendszer
    const loadPages = async () => {
        const pageElements = await Promise.all(pages.map(async (page, index) => {
            const element = document.createElement('div');
            element.className = 'page';
            
            if(page.type === 'image') {
                const img = new Image();
                img.src = page.path;
                img.className = 'cover-image';
                element.appendChild(img);
            } else {
                try {
                    const response = await fetch(page.path);
                    element.innerHTML = await response.text();
                } catch(error) {
                    element.innerHTML = `<div class="page-content">
                        <h2>Hiba</h2><p>${error.message}</p></div>`;
                }
            }
            return element;
        }));
        
        pageFlip.loadFromHTML(pageElements);
        document.getElementById('loading').style.display = 'none';
        pageFlip.update();
    };

    // Interakciókezelés
    const setupInteractions = () => {
        let touchStart = 0;
        
        // Touch események
        document.addEventListener('touchstart', e => {
            touchStart = e.touches[0].clientX;
        }, { passive: true });

        document.addEventListener('touchend', e => {
            const delta = e.changedTouches[0].clientX - touchStart;
            if(Math.abs(delta) > 50) delta > 0 ? pageFlip.flipPrev() : pageFlip.flipNext();
        }, { passive: true });

        // Egér események
        document.addEventListener('mousedown', e => touchStart = e.clientX);
        document.addEventListener('mouseup', e => {
            const delta = e.clientX - touchStart;
            if(Math.abs(delta) > 50) delta > 0 ? pageFlip.flipPrev() : pageFlip.flipNext();
        });

        // Billentyűzet
        document.addEventListener('keydown', e => {
            if(e.key === 'ArrowLeft') pageFlip.flipPrev();
            if(e.key === 'ArrowRight') pageFlip.flipNext();
        });
    };

    // Eseménykezelők
    pageFlip.on('flip', e => {
        document.getElementById('page-indicator').textContent = 
            `Oldal ${e.data + 1} / ${pageFlip.getPageCount()}`;
        
        if(!document.getElementById('mute-button').classList.contains('muted')) {
            document.getElementById('flipSound').play().catch(() => {});
        }
    });

    // Reszponzív méretezés
    const handleResize = () => {
        pageFlip.updateSize(
            Math.min(1100, window.innerWidth - 40),
            Math.min(800, window.innerHeight - 40)
        );
        pageFlip.update();
    };

    window.addEventListener('resize', handleResize);
    handleResize();

    // Indítás
    loadPages().then(setupInteractions);
});
</script>

<style>
/* Reszponzív frissítések */
#book {
    width: 100vw !important;
    height: 100vh !important;
    max-width: 1100px;
    margin: 0 auto;
}

.stf__wrapper {
    width: 100% !important;
    height: 100% !important;
    overflow: hidden;
}

.page {
    width: 100% !important;
    height: 100% !important;
    background: #f9f7e8;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    #book {
        max-width: 100%;
        padding: 10px;
    }
    
    .page-content {
        padding: 15px !important;
    }
}

/* PWA specifikus stílusok */
@media (display-mode: standalone) {
    #fullscreen-button {
        display: none !important;
    }
}
</style>